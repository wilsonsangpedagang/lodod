{% extends 'base.html' %}
{% load humanize %}
{% block content %}

{% include 'navbar.html' %}

<style>
  /* Reset & Basic Styles */
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin: 0;
    padding: 0;
    background: #FEF9F9;
    color: #333;
  }
  .container {
    max-width: 1100px;
    margin: 24px auto;
    padding: 16px;
  }

  /* Page Header */
  .page-header { margin: 24px 0; }
  .page-header h1 { font-size: 2.5rem; font-weight: 700; color: #000000; margin: 0; }
  .page-header h1 .highlight { color: #6A1B9A; }

  /* ======================================= */
  /* NEW SEARCH BAR STYLES (Venue Style)   */
  /* ======================================= */
  .search-bar {
    display: flex;
    flex-wrap: wrap; /* Agar bisa turun baris di layar kecil */
    gap: 16px;
    align-items: center;
    margin-bottom: 32px; /* Jaga jarak bawah */
    background: none;
    box-shadow: none;
    padding: 0;
  }
  .search-input {
    flex: 1; /* Biarkan input mengisi ruang */
    padding: 12px 16px;
    font-size: 1rem;
    border: 2px solid #6A1B9A; /* Border ungu */
    border-radius: 8px;
    min-width: 180px; /* Lebar minimum */
    box-sizing: border-box; /* Agar padding tidak merusak layout */
  }
  .search-input::placeholder {
    color: #aaa;
  }
  select.search-input {
    appearance: none; /* Hapus tampilan default dropdown */
    background-color: white; /* Pastikan ada background */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    padding-right: 2.5rem; /* Ruang untuk panah */
  }
  .search-btn, .add-btn {
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    text-align: center;
    transition: background-color 0.2s ease, transform 0.2s ease;
  }
  .search-btn {
    background-color: #6A1B9A; /* Ungu */
    color: white;
  }
  .search-btn:hover {
    background-color: #5a1683; /* Ungu lebih gelap */
    transform: translateY(-2px);
  }
  .add-btn {
    background-color: #FFED2C; /* Kuning */
    color: #000;
  }
   .add-btn:hover {
    background-color: #f0de20; /* Kuning lebih gelap */
    transform: translateY(-2px);
  }
  /* ======================================= */
  /* END NEW SEARCH BAR STYLES             */
  /* ======================================= */

  /* Event Grid */
  .event-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
  @media (max-width: 768px) {
    .event-grid { grid-template-columns: 1fr; }
    .search-bar { flex-direction: column; align-items: stretch; } /* Update for responsiveness */
  }

  /* Event Card Wrapper */
  .event-card-wrapper {
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid #f0f0f0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .event-card-wrapper:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.07);
  }

  /* Bagian Atas Kartu (Klik) */
  .event-card-clickable {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    padding: 24px;
    cursor: pointer;
  }
  .card-logo img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #f0f0f0; }
  .card-details { flex: 1; }
  .card-details h2 { font-size: 1.5rem; font-weight: 600; color: #000000; margin: 0 0 4px 0; }
  .card-details .subtitle { font-size: 0.95rem; color: #666; margin: 0 0 16px 0; }
  .card-details ul { list-style: none; padding: 0; margin: 0; }
  .card-details li { display: flex; align-items: center; color: #333; margin-bottom: 10px; font-size: 0.9rem; }
  .card-details .icon { width: 16px; height: 16px; margin-right: 12px; fill: #555; flex-shrink: 0; }

  /* Tombol di Kartu */
  .card-actions {
    display: flex;
    justify-content: right; /* Tetap di kanan */
    gap: 8px;
    padding: 15px 20px 20px 20px; /* Padding atas 15px */
    border-top: 1px solid #f5f5f5;
    margin-top: 10px;
  }

  /* ============================================ */
  /* NEW TRANSPARENT BUTTON STYLES FOR CARD     */
  /* ============================================ */
  /* Tombol Edit di Kartu */
  /* Tombol Edit di Kartu */
  .btn-edit-card {
    background-color: transparent; /* Background awal transparan */
    color: #555;                 /* Warna teks abu-abu gelap */
    border: 1px solid transparent;
    border-radius: 4px;         /* Bentuk kotak */
    padding: 8px 16px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; /* Transisi background & color */
  }
  .btn-edit-card:hover {
    background-color: #eee;     /* Background abu-abu terang pas hover */
    color: #555;                 /* Teks tetap abu-abu gelap */
  }

  /* Tombol Delete di Kartu */
  .btn-delete-card {
    background-color: transparent; /* Background awal transparan */
    color: #D9534F;             /* Warna teks merah */
    border: 1px solid transparent;
    border-radius: 4px;         /* Bentuk kotak */
    padding: 8px 16px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; /* Transisi background & color */
  }
  .btn-delete-card:hover {
    background-color: #fdd;     /* Background merah muda pas hover */
    color: #D9534F;             /* Teks tetap merah */
  }
  /* ============================================ */
  /* END NEW BUTTON STYLES                      */
  /* ============================================ */

  /* Modal styles (Perbaikan display & centering) */
  .modal {
    display: none;
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.4); z-index: 1001; overflow-y: auto;
    align-items: center; justify-content: center; padding: 20px;
  }
  .modal.is-active { display: flex; } /* Show modal with flex */
  .modal .modal-content {
    background: #fff; max-width: 800px; width: 100%; margin: 0;
    padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #0002; position: relative;
  }
  .modal .modal-close { position:absolute; top:12px; right:16px; font-size:1.5em; background:none; border:none; cursor:pointer; font-weight: bold; color: #888; transition: color 0.2s ease; }
  .modal .modal-close:hover { color: #000; }
  #addEventFormMsg, #editEventFormMsg { margin-top: 12px; font-weight: 600; }
  .btn-submit-form { width: 100%; margin-top: 16px; background-color: #6A1B9A; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease, transform 0.2s ease;}
  .btn-submit-form:hover { background-color: #5a1683; transform: translateY(-2px); }

  /* Footer */
  footer { text-align: center; color: #666; padding: 24px 0; font-size: 0.9rem; border-top: 1px solid #eee; margin-top: 40px; }
</style>

<svg width="0" height="0" style="display:none;">
    <symbol id="icon-search" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-map-pin" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></symbol>
    <symbol id="icon-dollar" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c2.11-.46 3.5-1.7 3.5-3.6 0-2.03-1.4-3.53-4.2-4.15z"/></symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></symbol>
    <symbol id="icon-user" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
</svg>

<main class="container" role="main">

  <div class="page-header">
    <h1>FIND YOUR NEXT <span class="highlight">MATCH</span></h1>
  </div>

  <form class="search-bar" action="{% url 'main:event_page' %}" method="GET">
    <input type="text" name="q" class="search-input" placeholder="Search Event Name/Desc" value="{{ search_query|default:'' }}">
    <select name="city" class="search-input">
      <option value="">Choose City</option>
      <option value="jakarta" {% if city_filter == 'jakarta' %}selected{% endif %}>Jakarta</option>
      <option value="bogor" {% if city_filter == 'bogor' %}selected{% endif %}>Bogor</option>
      <option value="bandung" {% if city_filter == 'bandung' %}selected{% endif %}>Bandung</option>
    </select>
    <select name="price" class="search-input">
      <option value="">Choose Price Range</option>
      <option value="<100k" {% if price_filter == '<100k' %}selected{% endif %}>&lt; Rp 100.000</option>
      <option value="100k-200k" {% if price_filter == '100k-200k' %}selected{% endif %}>Rp 100.000 - Rp 200.000</option>
      <option value=">200k" {% if price_filter == '>200k' %}selected{% endif %}>&gt; Rp 200.000</option>
    </select>
    <button type="submit" class="search-btn">Search</button> {% if user.is_authenticated %}
      <a href="#" id="publishBtn" class="add-btn">+ Add Events</a> {% endif %}
  </form>
  <div class="event-grid" id="eventGrid">
    {% for event in events %}
      <div class="event-card-wrapper">
        <div class="event-card-clickable" data-id="{{ event.id }}">
          <div class="card-logo">
            <img src="{{ event.image_url|default:'https://placehold.co/80x80/FEF9F9/6A1B9A?text=RQ' }}" alt="{{ event.name }} logo">
          </div>
          <div class="card-details">
            <h2>{{ event.name }}</h2>
            <p class="subtitle">{{ event.type }}</p>
            <ul>
              <li><svg class="icon"><use href="#icon-calendar"></use></svg> {{ event.date|date:"d F Y, H:i" }} WIB</li>
              <li><svg class="icon"><use href="#icon-map-pin"></use></svg> {{ event.venue.name }}</li>
              <li><svg class="icon"><use href="#icon-dollar"></use></svg> Rp {{ event.price|intcomma }}</li>
            </ul>
          </div>
        </div>

        {% if user.is_authenticated and event.user == user %}
          <div class="card-actions">
            <button class="btn-edit-card" data-id="{{ event.id }}">Edit</button>
            <button class="btn-delete-card" data-id="{{ event.id }}">Delete</button>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>There are no events available. Please check back later!</p>
    {% endfor %}
  </div>
</main>

<div id="detailModal" class="modal"> 
    <div class="modal-content">
      <button id="closeDetailModal" class="modal-close">&times;</button>
      <div id="detailContentContainer"> 
        </div>
    </div>
  </div>
  
  <div id="addEventModal" class="modal"> 
    <div class="modal-content">
      <button id="closeAddEventModal" class="modal-close">&times;</button>
      <h2>Add New Event</h2>
      <div id="addEventFormContainer">
        </div>
      <div id="addEventFormMsg"></div> </div>
  </div>
  
  <div id="editEventModal" class="modal"> 
    <div class="modal-content">
      <button id="closeEditEventModal" class="modal-close">&times;</button>
      <h2>Edit Event</h2>
      <div id="editEventFormContainer">
        </div>
      <div id="editEventFormMsg"></div> </div>
  </div>
  
  <footer>
    <small>Copyright @PadelinAja. All Rights Reserved.</small>
  </footer>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // --- Variabel Modal ---
        const detailModal = document.getElementById('detailModal');
        const closeDetailModal = document.getElementById('closeDetailModal');
        const detailContentContainer = document.getElementById('detailContentContainer');
        const addEventModal = document.getElementById('addEventModal');
        const addEventBtn = document.getElementById('publishBtn'); // Tombol '+ Add Events'
        const closeAddEventModal = document.getElementById('closeAddEventModal');
        const addEventFormContainer = document.getElementById('addEventFormContainer');
        const addEventFormMsg = document.getElementById('addEventFormMsg');
        const editEventModal = document.getElementById('editEventModal');
        const closeEditEventModal = document.getElementById('closeEditEventModal');
        const editEventFormContainer = document.getElementById('editEventFormContainer');
        const editEventFormMsg = document.getElementById('editEventFormMsg');
        const eventGrid = document.getElementById('eventGrid');
    
        // === Fungsi Buka/Tutup Modal ===
        function openModal(modalElement) {
            if(modalElement) modalElement.classList.add('is-active'); 
        }
        function closeModal(modalElement) {
            if(modalElement) modalElement.classList.remove('is-active'); 
        }
    
        // --- Penanganan Modal Add Event ---
        // Pastikan tombolnya ada sebelum menambahkan listener
        if (addEventBtn) {
            addEventBtn.onclick = function(e) {
                e.preventDefault();
                addEventFormContainer.innerHTML = '<p>Loading form...</p>';
                addEventFormMsg.textContent = '';
                openModal(addEventModal); 
                fetch(`/ajax_event_form/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                    .then(r => r.json())
                    .then(data => { 
                        if(data.html) {
                            addEventFormContainer.innerHTML = data.html; 
                            attachFormHandler(addEventFormContainer, addEventFormMsg, addEventModal); 
                        } else { addEventFormContainer.innerHTML = '<p>Error: Could not load form.</p>'; }
                    })
                    .catch(error => { console.error('Error fetching event form:', error); });
            }
        } else {
            console.warn("Add Event button ('#publishBtn') not found."); // Pesan jika tombol tidak ada (misal user belum login)
        }
    
        // --- Event Listener Terpusat di Grid ---
        // Pastikan gridnya ada
        if (eventGrid) {
            eventGrid.addEventListener('click', function(e) {
                const clickableCard = e.target.closest('.event-card-clickable');
                const editButton = e.target.closest('.btn-edit-card');
                const deleteButton = e.target.closest('.btn-delete-card');
    
                // --- Klik Tombol DELETE ---
                if (deleteButton) {
                    e.preventDefault();
                    const eventId = deleteButton.dataset.id;
                    if (confirm('Are you sure you want to delete this event?')) {
                        const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                        fetch(`/ajax_delete/event/${eventId}/`, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) { location.reload(); } 
                            else { alert('Error deleting event: ' + data.errors); }
                        })
                        .catch(error => { console.error('Error deleting event:', error); });
                    }
                    return; 
                }
    
                // --- Klik Tombol EDIT ---
                if (editButton) {
                    e.preventDefault();
                    const eventId = editButton.dataset.id;
                    editEventFormContainer.innerHTML = '<p>Loading edit form...</p>';
                    editEventFormMsg.textContent = '';
                    openModal(editEventModal); 
    
                    fetch(`/ajax_edit/event/${eventId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                    .then(response => response.json())
                    .then(data => {
                        if (data.html) {
                            editEventFormContainer.innerHTML = data.html;
                            attachFormHandler(editEventFormContainer, editEventFormMsg, editEventModal);
                        } else { editEventFormContainer.innerHTML = '<p>Sorry, edit form could not be loaded.</p>'; }
                    })
                    .catch(error => { console.error('Error fetching edit form:', error); });
                    return; 
                }
    
                // --- Klik Area KARTU ---
                if (clickableCard) {
                    const eventId = clickableCard.dataset.id;
                    detailContentContainer.innerHTML = '<p>Loading details...</p>';
                    openModal(detailModal); 
    
                    fetch(`/ajax_event_detail/${eventId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                    .then(response => response.json())
                    .then(data => {
                        if (data.html) { detailContentContainer.innerHTML = data.html; } 
                        else { detailContentContainer.innerHTML = '<p>Sorry, details could not be loaded.</p>'; }
                    })
                    .catch(error => { console.error('Error fetching event details:', error); });
                }
            });
        } else {
             console.warn("Event grid ('#eventGrid') not found.");
        }
    
        // --- Fungsi Handler Form ---
        function attachFormHandler(formContainer, msgContainer, modalInstance) {
            const form = formContainer.querySelector('form'); 
            if (!form) return;
            form.onsubmit = function(e) {
                e.preventDefault();
                msgContainer.textContent = '';
                const data = new FormData(form);
                const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                fetch(form.action, { 
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                    body: data
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        msgContainer.style.color = '#080';
                        msgContainer.textContent = 'Success!';
                        setTimeout(() => { location.reload(); }, 1200);
                    } else {
                        msgContainer.style.color = '#b00';
                        msgContainer.textContent = 'Please correct the errors in the form.';
                        if (res.errors && typeof res.errors === 'string') {
                             try { // Coba parse jika error-nya JSON string
                                const errors = JSON.parse(res.errors); 
                                form.querySelectorAll('.form-error').forEach(el => el.remove());
                                for (const fieldName in errors) {
                                    const field = form.querySelector(`[name="${fieldName}"]`);
                                    const errorList = errors[fieldName];
                                    if (field && errorList.length > 0) {
                                        const errorEl = document.createElement('div');
                                        errorEl.className = 'form-error';
                                        errorEl.style.color = '#b00';
                                        errorEl.style.fontSize = '0.85rem';
                                        errorEl.style.marginTop = '4px';
                                        errorEl.textContent = errorList.map(e => e.message).join(' ');
                                        field.parentNode.insertBefore(errorEl, field.nextSibling);
                                    }
                                }
                            } catch (e) { 
                                 msgContainer.textContent = res.errors; // Jika bukan JSON, tampilkan string error
                                 console.error('Could not parse form errors JSON:', e); 
                            }
                        } else if (typeof res.errors === 'string') { // Jika error sudah string
                             msgContainer.textContent = res.errors;
                        }
                    }
                })
                .catch(error => { console.error('Error submitting form:', error); });
            };
        }
    
        // --- Fungsi Penutup Modal ---
        if(closeDetailModal) closeDetailModal.onclick = () => { closeModal(detailModal); }
        if(closeAddEventModal) closeAddEventModal.onclick = () => { closeModal(addEventModal); }
        if(closeEditEventModal) closeEditEventModal.onclick = () => { closeModal(editEventModal); }
    
        window.onclick = e => {
            if (e.target == detailModal) closeModal(detailModal);
            if (e.target == addEventModal) closeModal(addEventModal);
            if (e.target == editEventModal) closeModal(editEventModal);
        };
    
    });
    </script>

{% endblock content %}