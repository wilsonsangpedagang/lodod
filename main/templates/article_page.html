{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

{% include 'navbar.html' %}

<style>
  /* ... (CSS Dasar, Container, Header, Grid, Footer kamu tetap sama) ... */
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; padding: 0; background: #FEF9F9; color: #333; }
  .container { max-width: 1100px; margin: 24px auto; padding: 16px; }
  .page-header { margin: 24px 0 32px 0; display: flex; justify-content: space-between; align-items: center; } /* Ubah jadi flex */
  .page-header h1 { font-size: 2.5rem; font-weight: 700; color: #000000; margin: 0; }
  .page-header h1 .highlight { color: #6A1B9A; }
  .blog-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; }
  @media (max-width: 992px) { .blog-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px) { .blog-grid { grid-template-columns: 1fr; } }
  footer { text-align: center; color: #666; padding: 24px 0; font-size: 0.9rem; border-top: 1px solid #eee; margin-top: 40px; }

  /* Tombol Add Blog (Ungu) */
  .btn-add-blog {
    background-color: #6A1B9A;
    color: #FFFFFF;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    text-decoration: none;
    white-space: nowrap;
    transition: background-color 0.2s ease, transform 0.2s ease;
  }
  .btn-add-blog:hover {
    background-color: #5a1683;
    transform: translateY(-2px);
  }

  /* Blog Card Wrapper */
  .blog-card-wrapper {
    background: #FFFFFF;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid #f0f0f0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; /* Agar tombol bisa nempel di bawah */
    flex-direction: column; /* Konten di atas, tombol di bawah */
  }
  .blog-card-wrapper:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.07);
  }
  
  /* Konten Kartu */
  .blog-card-content-top {
      padding: 20px;
      flex-grow: 1; /* Biarkan konten mengisi ruang */
  }
  .blog-card img { width: 100%; height: 200px; object-fit: cover; display: block; }
  .blog-card h2 { font-size: 1.25rem; font-weight: 600; color: #000000; margin: 0 0 12px 0; }
  .blog-card p { font-size: 0.95rem; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 16px; }
  .blog-card .learn-more { font-size: 0.9rem; font-weight: 600; color: #6A1B9A; text-decoration: none; transition: color 0.2s ease; }
  .blog-card .learn-more:hover { color: #5a1683; }

  /* Tombol Edit/Delete di Kartu */
  .card-actions {
    display: flex;
    justify-content: flex-end; /* Taruh di kanan */
    gap: 8px;
    padding: 15px 20px; /* Padding atas/bawah */
    border-top: 1px solid #f5f5f5;
    margin-top: auto; /* Paksa nempel di bawah */
  }
  /* Tombol Edit di Kartu */
  .btn-edit-card {
    background-color: transparent; /* Background awal transparan */
    color: #555;                 /* Warna teks abu-abu gelap */
    border: 1px solid transparent;
    border-radius: 4px;         /* Bentuk kotak */
    padding: 8px 16px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; /* Transisi background & color */
  }
  .btn-edit-card:hover {
    background-color: #eee;     /* Background abu-abu terang pas hover */
    color: #555;                 /* Teks tetap abu-abu gelap */
  }

  /* Tombol Delete di Kartu */
  .btn-delete-card {
    background-color: transparent; /* Background awal transparan */
    color: #D9534F;             /* Warna teks merah */
    border: 1px solid transparent;
    border-radius: 4px;         /* Bentuk kotak */
    padding: 8px 16px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; /* Transisi background & color */
  }
  .btn-delete-card:hover {
    background-color: #fdd;     /* Background merah muda pas hover */
    color: #D9534F;             /* Teks tetap merah */
  }

  /* Modal Styles (Sama seperti event_page.html) */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 1001; overflow-y: auto; align-items: center; justify-content: center; padding: 20px; }
  .modal.is-active { display: flex; }
  .modal .modal-content { background: #fff; max-width: 600px; width: 100%; margin: 0; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #0002; position: relative; }
  .modal .modal-close { position:absolute; top:12px; right:16px; font-size:1.5em; background:none; border:none; cursor:pointer; font-weight: bold; color: #888; transition: color 0.2s ease; }
  .modal .modal-close:hover { color: #000; }
  #addBlogFormMsg, #editBlogFormMsg { margin-top: 12px; font-weight: 600; }
  .btn-submit-form { width: 100%; margin-top: 16px; background-color: #6A1B9A; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease, transform 0.2s ease;}
  .btn-submit-form:hover { background-color: #5a1683; transform: translateY(-2px); }
</style>

<svg width="0" height="0" style="display:none;">
    </svg>

<main class="container" role="main">

  <div class="page-header">
    <h1>BLOGS <span class="highlight">AND </span>UPDATES</h1>
    {% if user.is_authenticated %}
      <a href="#" id="addBlogBtn" class="btn-add-blog">+ Add Blog</a>
    {% endif %}
  </div>

  <div class="blog-grid" id="blogGrid"> {% for article in articles %}
      <div class="blog-card-wrapper">
        <article class="blog-card">
          <a href="{% url 'main:show_article' article.id %}"> <img src="{{ article.image_url|default:'https://placehold.co/600x400/eee/ccc?text=Blog+Image' }}" alt="{{ article.title }}">
          </a>
          <div class="blog-card-content-top">
            <h2>{{ article.title }}</h2>
            <p style="font-size: 0.9em; color: #666; margin-top: -8px; margin-bottom: 12px; font-weight: 500;">
              {{ article.category }}
            </p>
            <p>{{ article.content|truncatewords:30 }}</p>
            <a href="{% url 'main:show_article' article.id %}" class="learn-more">Learn More â†’</a>
          </div>
        </article>
        
        {% if user.is_authenticated and article.user == user %}
          <div class="card-actions">
            <button class="btn-edit-card" data-id="{{ article.id }}">Edit</button>
            <button class="btn-delete-card" data-id="{{ article.id }}">Delete</button>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>No blog posts available yet.</p>
    {% endfor %}
  </div>

</main>

<div id="addBlogModal" class="modal">
  <div class="modal-content">
    <button id="closeAddBlogModal" class="modal-close">&times;</button>
    <h2>Add New Blog Post</h2>
    <div id="addBlogFormContainer"></div>
    <div id="addBlogFormMsg"></div>
  </div>
</div>

<div id="editBlogModal" class="modal">
  <div class="modal-content">
    <button id="closeEditBlogModal" class="modal-close">&times;</button>
    <h2>Edit Blog Post</h2>
    <div id="editBlogFormContainer"></div>
    <div id="editBlogFormMsg"></div>
  </div>
</div>

<footer>
  <small>Copyright @PadelinAja. All Rights Reserved.</small>
</footer>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- Variabel Modal ---
    const addBlogModal = document.getElementById('addBlogModal');
    const addBlogBtn = document.getElementById('addBlogBtn'); // Tombol '+ Add Blog'
    const closeAddBlogModal = document.getElementById('closeAddBlogModal');
    const addBlogFormContainer = document.getElementById('addBlogFormContainer');
    const addBlogFormMsg = document.getElementById('addBlogFormMsg');

    const editBlogModal = document.getElementById('editBlogModal');
    const closeEditBlogModal = document.getElementById('closeEditBlogModal');
    const editBlogFormContainer = document.getElementById('editBlogFormContainer');
    const editBlogFormMsg = document.getElementById('editBlogFormMsg');

    const blogGrid = document.getElementById('blogGrid');

    // === Fungsi Buka/Tutup Modal ===
    function openModal(modalElement) { modalElement.classList.add('is-active'); }
    function closeModal(modalElement) { modalElement.classList.remove('is-active'); }

    // --- Penanganan Modal Add Blog ---
    // Pastikan tombolnya ada (jika user login)
    if (addBlogBtn) {
        addBlogBtn.onclick = function(e) {
            e.preventDefault();
            addBlogFormContainer.innerHTML = '<p>Loading form...</p>';
            addBlogFormMsg.textContent = '';
            openModal(addBlogModal);
            
            // Panggil view AJAX untuk form artikel
            fetch(`/ajax_article_form/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(r => r.json())
                .then(data => { 
                    if(data.html) {
                        addBlogFormContainer.innerHTML = data.html; 
                        attachFormHandler(addBlogFormContainer, addBlogFormMsg, addBlogModal); 
                    } else { addBlogFormContainer.innerHTML = '<p>Error: Could not load form.</p>'; }
                })
                .catch(error => { console.error('Error fetching blog form:', error); });
        }
    }

    // --- Event Listener Terpusat di Grid ---
    if (blogGrid) {
        blogGrid.addEventListener('click', function(e) {
            const editButton = e.target.closest('.btn-edit-card');
            const deleteButton = e.target.closest('.btn-delete-card');

            // --- Klik Tombol DELETE ---
            if (deleteButton) {
                e.preventDefault(); // Mencegah link kartu ter-klik
                const articleId = deleteButton.dataset.id;
                if (confirm('Are you sure you want to delete this blog post?')) {
                    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                    // Panggil view ajax_delete dengan tipe 'article'
                    fetch(`/ajax_delete/article/${articleId}/`, { 
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) { location.reload(); } 
                        else { alert('Error deleting post: ' + data.errors); }
                    })
                    .catch(error => { console.error('Error deleting post:', error); });
                }
                return; 
            }

            // --- Klik Tombol EDIT ---
            if (editButton) {
                e.preventDefault(); // Mencegah link kartu ter-klik
                const articleId = editButton.dataset.id;
                editBlogFormContainer.innerHTML = '<p>Loading edit form...</p>';
                editBlogFormMsg.textContent = '';
                openModal(editBlogModal); 

                // Panggil view ajax_edit dengan tipe 'article'
                fetch(`/ajax_edit/article/${articleId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(response => response.json())
                .then(data => {
                    if (data.html) {
                        editBlogFormContainer.innerHTML = data.html;
                        attachFormHandler(editBlogFormContainer, editBlogFormMsg, editBlogModal);
                    } else { editBlogFormContainer.innerHTML = '<p>Sorry, edit form could not be loaded.</p>'; }
                })
                .catch(error => { console.error('Error fetching edit form:', error); });
                return; 
            }

            // Jika klik area lain di dalam grid (bukan tombol), biarkan link kartu bekerja
        });
    }

    // --- Fungsi Handler Form (Sama seperti event) ---
    function attachFormHandler(formContainer, msgContainer, modalInstance) {
        const form = formContainer.querySelector('form'); 
        if (!form) return;
        form.onsubmit = function(e) {
            e.preventDefault();
            msgContainer.textContent = '';
            const data = new FormData(form);
            const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            fetch(form.action, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                body: data
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    msgContainer.style.color = '#080';
                    msgContainer.textContent = 'Success!';
                    setTimeout(() => { location.reload(); }, 1200);
                } else {
                    msgContainer.style.color = '#b00';
                    msgContainer.textContent = 'Please correct the errors in the form.';
                    // Tampilkan error per field
                    if (typeof res.errors === 'object' && res.errors !== null) {
                         try {
                            const errors = JSON.parse(res.errors); 
                            form.querySelectorAll('.form-error').forEach(el => el.remove());
                            for (const fieldName in errors) {
                                const field = form.querySelector(`[name="${fieldName}"]`);
                                const errorList = errors[fieldName];
                                if (field && errorList.length > 0) {
                                    const errorEl = document.createElement('div');
                                    errorEl.className = 'form-error';
                                    errorEl.style.color = '#b00';
                                    errorEl.style.fontSize = '0.85rem';
                                    errorEl.style.marginTop = '4px';
                                    errorEl.textContent = errorList.map(e => e.message).join(' ');
                                    field.parentNode.insertBefore(errorEl, field.nextSibling);
                                }
                            }
                        } catch (e) { console.error('Could not parse form errors:', e); }
                    } else if (typeof res.errors === 'string') {
                         msgContainer.textContent = res.errors; // Tampilkan error string jika ada
                    }
                }
            })
            .catch(error => { console.error('Error submitting form:', error); });
        };
    }

    // --- Fungsi Penutup Modal ---
    if (closeAddBlogModal) closeAddBlogModal.onclick = () => { closeModal(addBlogModal); }
    if (closeEditBlogModal) closeEditBlogModal.onclick = () => { closeModal(editBlogModal); }

    window.onclick = e => {
        if (e.target == addBlogModal) closeModal(addBlogModal);
        if (e.target == editBlogModal) closeModal(editBlogModal);
    };

});
</script>

{% endblock content %}